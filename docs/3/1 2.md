# 도커 허브에 공유된 이미지 사용하기.  

- 명시적으로 원하는 이미지를 도커허브에서  내려받을 수 있음.
- `docker iamge pull diamol/ch03-web-ping`

- 도커 이미지는 물리적으로 여러 개의 작은 파이롤 구성되어있고, 도커는 이 파일들을 조립해 컨테이너 내부 파일 시스템을 만든다. 그리고 모든 이미지 레이어를 다운하고나면 전체 이미지를 사용할 수 있다.
- 내려받은 이미지를 실행해보자
- `docker container run -d --name web-ping diamol/ch03-web-ping`
- -d는 00detach의 축약형, 
- --name은 container id가 아닌 별칭을 지정한다.


- 도커 실행시 환경변수값 부여를 통해 이 값을 기반으로 어플리케이션의 행동을 제어할 수 있다.


<br>

# Dockerfile 작성하는법

- 어플리케이션 패키징 스크립트


```yml
FROM diamol/node

ENV TARGET="blog.sixeyed.com"
ENV METHOD="HEAD"
ENV INTERVAL="3000"

WORKDIR /web-ping
COPY app.js

CMD ["node", "/web-ping/app.js"]
```

## 지시어

- FROM: 시작하는 이미지를 의미한다. 모든 도커 이미지는 다른 이미지로부터 시작한다.
- ENV: 환경변수 지정하는 명령어, 키-값 쌍의 형식을 따른다.
- WORKDIR: 컨테이너 이미지 파일 시스템에 디렉터리를 만들고 해당 디렉터리를 CWD로 지정하는 명령어. 
- COPY: 로컬 파일 시스템의 파일이나 디렉터리를 컨테이너로 복사한다. 
- CMD: 도커가 이미지로부터 컨테이너 실행시 실행할 명령어. 서버 실행한다.

- 이제 이 이미지로 빌드하려면 Dockerfile 스크립트 외에 이미지 이름, 파일경로를 추가로 지정해야한다.

- `docker image build --tag web-ping .`

## 이미지 레이어

- 도커 이미지에는 패키징에 포함시킨 모든 파일이 들어있고, 이 파일들이 컨테이너의 파일시스템을 형성한다.
- 또한 메타데이터 정보도 들어있다.
- 도커 이미지는 이미지 레이어가 모인 것이며, 이 이미지 레이어들은 도커 엔진 캐시에 물리적으로 저장되어있다.
- `이미지 레이어는 여러 이미지, 컨테이너에서 공유되기 때문에 디스크 용량을 줄일 수 있다.`

<br>

- 도커 파일의 명령어들은 모두 각각 1개의 이미지 레이어와 1:1로 연결된다.
- 명령어의 결과가 이전 빌드와 같다면 이전에 캐시된 레이어를 그대로 사용.
- 다르다면 그 명령어와 이후에 오는 모든 명령어를 실행한다.
- `따라서, 잘 수정되지 않는 명령어가 앞으로 오고, 자주 수정되는 명령이 뒤에 오도록 배치`


## 이미지 커밋

- 일반적으로, 도커 컨테이너에서 작업한 내용은 컨테이너가 종료되면 같이 사라진다.
- 그래서 컨테이너 상에서 작업한 내용을 이미지로 커밋해 해당 이미지로부터 다시 컨테이너를 실행해 작업한 내용을 다시 사용할 수 있다.

1. 실행중인 도커 컨테이너 종료
2. 종료된 도커 컨테이너 ID확인(혹은 --tag된 이름 확인)
3. `docker commit [container Id | tag name] [new image name]`으로 종료된 컨테이너 상태 그대로 이미지 생성
4. 새로 생성된 이미지로부터 컨테이너 실행가능.
